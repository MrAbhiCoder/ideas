<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WealthVerse | v15 Pro Tools</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --card-glass: rgba(15, 23, 42, 0.95);
            --border-glass: rgba(255, 255, 255, 0.15);
            --primary: #6366f1;
            --accent: #f43f5e;
            --success: #10b981;
            --gold: #f59e0b;
            --neon-blue: #00f3ff;
            --text-main: #f8fafc;
            --text-sub: #94a3b8;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        body { background: var(--bg-dark); color: var(--text-main); font-family: 'Outfit', sans-serif; min-height: 100vh; padding-bottom: 3rem; overflow-x: hidden; transition: background 0.3s ease; }
        
        /* MODES */
        body.mode-tools { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        body.mode-trader { background: radial-gradient(circle at center, #020617 0%, #000000 100%); }
        body.mode-run { background: linear-gradient(to bottom, #111827 0%, #374151 100%); }
        body.mode-kids { background: linear-gradient(120deg, #3b82f6 0%, #8b5cf6 100%); }

        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }

        header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 0; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-glass); }
        .brand { font-family: 'Space Grotesk', sans-serif; font-size: 1.8rem; font-weight: 700; background: linear-gradient(to right, #6366f1, #00f3ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* NAV */
        .nav-dock { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 1.5rem; }
        .menu-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--border-glass); padding: 12px; border-radius: 12px; color: var(--text-sub); font-weight: 700; font-size: 0.9rem; cursor: pointer; text-align: center; transition: 0.2s; }
        .menu-btn:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .menu-btn.active { background: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 0 0 15px rgba(99, 102, 241, 0.4); }

        /* VIEWS */
        .app-view { display: none; }
        .app-view.active-view { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1.5fr; gap: 1.5rem; }
        .game-grid { display: grid; grid-template-columns: 1fr 350px; gap: 1.5rem; }
        
        /* UI */
        .glass-card { background: var(--card-glass); border: 1px solid var(--border-glass); border-radius: 16px; padding: 1.5rem; margin-bottom: 1rem; }
        .input-wrap { margin-bottom: 1rem; }
        .input-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; color: var(--text-sub); font-size: 0.9rem; }
        .input-val { font-weight: 700; color: var(--primary); }
        input[type=range] { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 10px; -webkit-appearance: none; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #fff; margin-top: -6px; }
        .big-value { font-size: 2.5rem; font-weight: 800; background: linear-gradient(to right, #fff, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .chart-wrapper { position: relative; height: 300px; width: 100%; }

        /* GAMES UI */
        .game-screen { background: #020617; height: 450px; border-radius: 12px; border: 1px solid #334155; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .control-pad { display: flex; gap: 20px; width: 100%; justify-content: center; margin-top: 15px; }
        .ctrl-btn { width: 70px; height: 70px; border-radius: 50%; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; font-size: 1.5rem; cursor: pointer; }
        .kid-btn { padding: 15px; border-radius: 12px; font-weight: 800; cursor: pointer; border: none; font-size: 1rem; width: 100%; transition: transform 0.1s; }
        .kid-btn:active { transform: scale(0.95); }
        .btn-green { background: var(--success); color: #fff; }
        .btn-red { background: var(--accent); color: #fff; }
        .reset-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; }

        /* FINANCIAL RACE */
        #run_game { width: 100%; height: 100%; position: relative; background: linear-gradient(#1e1b4b, #be185d); overflow: hidden; }
        .road { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 300px; height: 100%; background: #334155; border-left: 10px solid #fff; border-right: 10px solid #fff; perspective: 100px;}
        .lane-marker { position: absolute; top: 0; left: 50%; width: 4px; height: 100%; background: repeating-linear-gradient(to bottom, #fff 0%, #fff 10%, transparent 10%, transparent 20%); animation: roadMove 0.5s linear infinite; }
        @keyframes roadMove { from { background-position: 0 0; } to { background-position: 0 100px; } }
        
        .player-car { position: absolute; bottom: 20px; width: 50px; height: 80px; background: var(--neon-blue); border-radius: 10px; z-index: 10; transition: left 0.1s; box-shadow: 0 0 20px var(--neon-blue); }
        .player-car::after { content:'üèéÔ∏è'; font-size: 3rem; position:absolute; left:-10px; top:-10px;}

        .game-obj { position: absolute; width: 80px; height: 40px; border-radius: 5px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; color: white; box-shadow: 0 5px 10px rgba(0,0,0,0.5); }
        .obj-bad { background: var(--accent); border: 2px solid white; }
        .obj-good { background: var(--gold); color: black; border: 2px solid white; }

        /* PIGGY DASH */
        #piggy_container { width: 100%; height: 100%; position: relative; background: #1e293b; overflow: hidden; }
        .piggy { position: absolute; bottom: 10px; width: 80px; height: 80px; background: #ec4899; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; border: 3px solid #fff; transition: left 0.1s; z-index: 10; }
        .drop-item { position: absolute; font-size: 3.5rem; transition: top 0.05s linear; }

        /* TRADER */
        .candle-timer { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; border: 1px solid var(--primary); font-family: monospace; }
        .trade-controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; margin-top: 10px; }
        .qty-input { background: rgba(0,0,0,0.3); border: 1px solid #555; color: white; text-align: center; padding: 10px; border-radius: 8px; width: 100%; }

        @media (max-width: 900px) { .dashboard-grid, .game-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body class="mode-tools">

<div class="container">
    <header>
        <div class="brand"><i class="ph-fill ph-currency-inr"></i> WealthVerse v15</div>
    </header>

    <nav class="nav-dock">
        <button class="menu-btn active" onclick="showSection('tools', this)">Calculators</button>
        <button class="menu-btn" onclick="showSection('arcade', this)">Arcade</button>
        <button class="menu-btn" onclick="showSection('kids', this)">Kids</button>
    </nav>

    <div id="section-tools" class="app-view active-view">
        <div style="display:flex; gap:10px; margin-bottom:1rem; overflow-x:auto;">
            <button class="reset-btn" onclick="openTool('sip')">SIP (Tax)</button>
            <button class="reset-btn" onclick="openTool('emi')">EMI (Yearly)</button>
            <button class="reset-btn" onclick="openTool('arb')">Arbitrage</button>
        </div>

        <div id="tool-sip" class="tool-content dashboard-grid">
            <div class="glass-card">
                <h3>SIP Calculator</h3><br>
                <div class="input-wrap"><div class="input-header"><label>Monthly</label><span class="input-val" id="sip_amt_val">25K</span></div><input type="range" id="sip_amt" min="1000" max="1000000" step="1000" value="25000"></div>
                <div class="input-wrap"><div class="input-header"><label>Years</label><span class="input-val" id="sip_years_val">10Y</span></div><input type="range" id="sip_years" min="1" max="40" step="1" value="10"></div>
                <div class="input-wrap"><div class="input-header"><label>Return</label><span class="input-val" id="sip_rate_val">12%</span></div><input type="range" id="sip_rate" min="5" max="30" step="0.5" value="12"></div>
            </div>
            <div class="glass-card">
                <div class="big-value" id="sip_final">‚Çπ 0</div>
                <div class="chart-wrapper"><canvas id="sipChart"></canvas></div>
            </div>
        </div>

        <div id="tool-emi" class="tool-content dashboard-grid" style="display:none;">
            <div class="glass-card">
                <h3>EMI Breakdown</h3><br>
                <div class="input-wrap"><div class="input-header"><label>Loan</label><span class="input-val" id="emi_amt_val">50L</span></div><input type="range" id="emi_amt" min="100000" max="100000000" step="100000" value="5000000"></div>
                <div class="input-wrap"><div class="input-header"><label>Years</label><span class="input-val" id="emi_years_val">20Y</span></div><input type="range" id="emi_years" min="1" max="40" step="1" value="20"></div>
                <div class="input-wrap"><div class="input-header"><label>Rate</label><span class="input-val" id="emi_rate_val">8.5%</span></div><input type="range" id="emi_rate" min="1" max="20" step="0.1" value="8.5"></div>
            </div>
            <div class="glass-card">
                <div class="big-value" id="emi_monthly">‚Çπ 0</div>
                <div class="chart-wrapper"><canvas id="emiChart"></canvas></div>
            </div>
        </div>

        <div id="tool-arb" class="tool-content dashboard-grid" style="display:none;">
            <div class="glass-card">
                <h3>Arbitrage</h3><br>
                <div class="input-wrap"><div class="input-header"><label>Loan</label><span class="input-val" id="arb_amt_val">50L</span></div><input type="range" id="arb_amt" min="100000" max="100000000" step="100000" value="5000000"></div>
                <div class="input-wrap"><div class="input-header"><label>Duration</label><span class="input-val" id="arb_years_val">10Y</span></div><input type="range" id="arb_years" min="1" max="50" step="1" value="10"></div>
                <div class="input-wrap"><div class="input-header"><label>Loan Rate</label><span class="input-val" id="arb_loan_rate_val">8%</span></div><input type="range" id="arb_loan_rate" min="1" max="20" step="0.1" value="8"></div>
                <div class="input-wrap"><div class="input-header"><label>Inv Return</label><span class="input-val" id="arb_inv_rate_val">12%</span></div><input type="range" id="arb_inv_rate" min="1" max="30" step="0.1" value="12"></div>
            </div>
            <div class="glass-card">
                <div class="big-value" id="arb_net">‚Çπ 0</div>
                <div class="chart-wrapper"><canvas id="arbChart"></canvas></div>
            </div>
        </div>
    </div>

    <div id="section-arcade" class="app-view">
        <div style="display:flex; gap:10px; margin-bottom:1rem; overflow-x:auto;">
            <button class="reset-btn" onclick="openArcade('trader')">Trader Pro</button>
            <button class="reset-btn" onclick="openArcade('defense')">Defense</button>
            <button class="reset-btn" onclick="openArcade('run')">Financial Race</button>
        </div>

        <div id="game-trader" class="arcade-content game-grid">
            <div class="glass-card">
                <div style="display:flex; justify-content:space-between;"><h3>Terminal</h3><button class="reset-btn" onclick="resetMM()">New Stock</button></div>
                <div class="game-screen">
                    <div class="candle-timer" id="trader_timer">5s</div>
                    <div style="position:absolute; top:10px; left:10px; color:#10b981; font-size:1.2rem;">PRICE: <span id="trader_price">...</span></div>
                    <canvas id="traderChart"></canvas>
                </div>
                <div class="trade-controls">
                    <select id="trader_qty" class="qty-input"><option value="1">Qty: 1</option><option value="10">Qty: 10</option><option value="100">Qty: 100</option></select>
                    <button class="kid-btn btn-green" onclick="traderAction(1)">BUY</button>
                    <button class="kid-btn btn-red" onclick="traderAction(-1)">SELL</button>
                </div>
            </div>
            <div class="glass-card"><h4>Portfolio</h4><div class="big-value" id="trader_eq">‚Çπ 10.0 L</div><p>Cash: <span id="trader_cash">10.0 L</span></p><p>Stocks: <span id="trader_hold">0</span></p></div>
        </div>

        <div id="game-run" class="arcade-content" style="display:none;">
            <div class="glass-card" style="border-color:var(--neon-blue);">
                <div style="display:flex; justify-content:space-between;"><h3>Financial Race</h3><div class="big-value" style="font-size:1.5rem;" id="run_score">0</div></div>
                <div class="game-screen" style="height:400px; margin-top:10px;">
                    <div id="run_game">
                        <div class="road"><div class="lane-marker"></div></div>
                        <div id="run_player" class="player-car"></div>
                        <div id="run_overlay" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:none; flex-direction:column; justify-content:center; align-items:center;"><h2>CRASHED!</h2><button class="kid-btn btn-green" onclick="startRun()">Try Again</button></div>
                    </div>
                </div>
                <div class="control-pad"><button class="ctrl-btn" onclick="moveRun(-1)"><</button><button class="ctrl-btn" onclick="moveRun(1)">></button></div>
            </div>
        </div>
    </div>

    <div id="section-kids" class="app-view">
        <div style="display:flex; gap:10px; margin-bottom:1rem;">
            <button class="reset-btn" onclick="openKid('coin')">Coin Quest</button>
            <button class="reset-btn" onclick="openKid('piggy')">Piggy Dash</button>
        </div>
        
        <div id="kid-coin" class="kid-content game-grid">
            <div class="glass-card" style="background:rgba(14,165,233,0.1); border-color:var(--success);">
                <div style="text-align:center;">
                    <h3>Coin Quest</h3>
                    <div style="font-size:1.5rem; margin:10px;">Item: <span id="kq_idx">1</span>/20</div>
                    <div style="font-size:6rem; margin:20px 0;" id="kq_icon">üçé</div>
                    <h2 id="kq_name">Apple</h2>
                    <div style="display:flex; gap:20px; justify-content:center; margin-top:20px;">
                        <button class="kid-btn btn-green" onclick="checkKQ('need')">NEED</button><button class="kid-btn btn-red" onclick="checkKQ('want')">WANT</button>
                    </div>
                    <div id="kq_res" style="margin-top:15px; font-weight:bold;"></div>
                </div>
            </div>
            <div class="glass-card"><h4>Score</h4><div class="big-value" id="kq_score">0</div></div>
        </div>

        <div id="kid-piggy" class="kid-content" style="display:none;">
            <div class="glass-card" style="border-color:var(--neon-pink);">
                <div style="display:flex; justify-content:space-between;"><h3>Piggy Dash</h3><div style="color:var(--gold); font-weight:bold;">‚Çπ <span id="pig_score">0</span></div></div>
                <div class="game-screen" id="piggy_container" style="margin-top:15px; border:2px solid var(--neon-pink);">
                    <div id="piggy_player" class="piggy">üê∑</div>
                    <div id="pig_overlay" style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); display:flex; flex-direction:column; justify-content:center; align-items:center;"><h2>Catch Money!</h2><button class="kid-btn btn-green" onclick="startPiggy()">START</button></div>
                </div>
                <div class="control-pad"><button class="ctrl-btn" onclick="movePig(-1)"><</button><button class="ctrl-btn" onclick="movePig(1)">></button></div>
            </div>
        </div>
    </div>

</div>

<script>
    const formatCurrency = (num) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(num);
    let charts = {};

    // --- NAVIGATION ---
    function showSection(id, btn) {
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        document.querySelectorAll('.app-view').forEach(v => v.classList.remove('active-view'));
        document.getElementById('section-' + id).classList.add('active-view');
        stopAllGames();
        if(id === 'tools') setTimeout(calcAll, 50);
        if(id === 'arcade') openArcade('trader');
        if(id === 'kids') openKid('coin');
    }

    function openTool(id) {
        document.querySelectorAll('.tool-content').forEach(d => d.style.display='none');
        document.getElementById('tool-' + id).style.display='grid';
        calcAll();
    }

    function openArcade(id) {
        document.querySelectorAll('.arcade-content').forEach(d => d.style.display='none');
        document.getElementById('game-' + id).style.display='grid';
        stopAllGames();
        if(id === 'trader') initTrader();
    }

    function openKid(id) {
        document.querySelectorAll('.kid-content').forEach(d => d.style.display='none');
        document.getElementById('kid-' + id).style.display='grid';
        stopAllGames();
        if(id === 'coin') loadKQ();
    }

    function stopAllGames() {
        if(traderInt) clearInterval(traderInt);
        if(runAnim) cancelAnimationFrame(runAnim);
        if(pigAnim) cancelAnimationFrame(pigAnim);
        if(pigSpawnInt) clearInterval(pigSpawnInt);
    }

    // --- CALCULATORS ---
    ['sip_amt','sip_years','sip_rate','emi_amt','emi_years','emi_rate','arb_amt','arb_loan_rate','arb_inv_rate','arb_years'].forEach(id => {
        document.getElementById(id).addEventListener('input', (e) => {
            let val = parseFloat(e.target.value);
            let suffix = id.includes('rate') ? '%' : (id.includes('years') ? ' Yrs' : '');
            let disp = suffix ? val + suffix : formatCurrency(val);
            document.getElementById(id + '_val').innerText = disp;
            calcAll();
        });
    });

    function calcAll() {
        // SIP (Tax)
        if(document.getElementById('tool-sip').style.display !== 'none') {
            const P=parseFloat(document.getElementById('sip_amt').value), N=parseFloat(document.getElementById('sip_years').value), R=parseFloat(document.getElementById('sip_rate').value);
            let val=0, mR=R/1200; for(let i=0;i<N*12;i++) val=(val+P)*(1+mR);
            let invested = P*N*12; let gain = val - invested;
            let tax = gain > 125000 ? (gain-125000)*0.125 : 0;
            document.getElementById('sip_final').innerText = formatCurrency(val - tax);
            drawChart('sipChart', 'line', Array.from({length:N},(_,i)=>i+1), Array.from({length:N},(_,i)=>{let t=0;for(let m=0;m<(i+1)*12;m++)t=(t+P)*(1+mR);return t}), '#6366f1');
        }
        // EMI (Stacked Bar)
        if(document.getElementById('tool-emi').style.display !== 'none') {
            const L=parseFloat(document.getElementById('emi_amt').value), Y=parseFloat(document.getElementById('emi_years').value), I=parseFloat(document.getElementById('emi_rate').value)/1200;
            const emi=(L*I*Math.pow(1+I,Y*12))/(Math.pow(1+I,Y*12)-1);
            document.getElementById('emi_monthly').innerText=formatCurrency(emi);
            // Gen Yearly Breakdown
            let bal=L, prinData=[], intData=[];
            for(let i=1; i<=Y; i++) {
                let yP=0, yI=0;
                for(let m=0; m<12; m++) {
                    let int=bal*I; let prin=emi-int;
                    yI+=int; yP+=prin; bal-=prin;
                }
                prinData.push(yP); intData.push(yI);
            }
            drawStackedBar('emiChart', Array.from({length:Y},(_,i)=>'Y'+(i+1)), prinData, intData);
        }
        // ARBITRAGE (Loan on Top)
        if(document.getElementById('tool-arb').style.display !== 'none') {
            const A=parseFloat(document.getElementById('arb_amt').value), Dur=parseFloat(document.getElementById('arb_years').value), lR=parseFloat(document.getElementById('arb_loan_rate').value)/100, iR=parseFloat(document.getElementById('arb_inv_rate').value)/100;
            let c=A, l=A, lbs=[], d1=[], d2=[];
            for(let i=1;i<=Dur;i++){ c*=(1+iR); l*=(1+lR); lbs.push("Y"+i); d1.push(c); d2.push(l); }
            document.getElementById('arb_net').innerText=formatCurrency(c-l);
            drawChart('arbChart', 'line', lbs, d1, '#10b981', d2);
        }
    }

    function drawChart(id, type, labels, d1, c1, d2=null) {
        const ctx = document.getElementById(id).getContext('2d');
        if(charts[id]) charts[id].destroy();
        let datasets = [{ label:'Invest', data:d1, borderColor:c1, backgroundColor:'rgba(16,185,129,0.2)', fill:true, order:2 }];
        if(d2) datasets.push({ label:'Loan', data:d2, borderColor:'#f43f5e', borderDash:[5,5], fill:false, order:1 });
        charts[id] = new Chart(ctx, { type, data:{labels,datasets}, options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:true}},scales:{x:{grid:{display:false}},y:{grid:{color:'#333'}}}} });
    }

    function drawStackedBar(id, labels, prin, int) {
        const ctx = document.getElementById(id).getContext('2d');
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label:'Principal', data:prin, backgroundColor:'#6366f1' }, { label:'Interest', data:int, backgroundColor:'#f43f5e' }] },
            options: { responsive:true, maintainAspectRatio:false, scales:{x:{stacked:true, grid:{display:false}}, y:{stacked:true, grid:{color:'#333'}}} }
        });
    }

    // --- GAME 1: TRADER PRO (FIXED SCALING & QTY) ---
    let traderInt, traderPrice=20000, traderEquity=1000000, traderHold=0, candleTime=0;
    let candleOpen=0, candleHigh=0, candleLow=0, candleClose=0;
    const MAX_CANDLES = 20;

    function initTrader() {
        traderPrice = 100 + Math.random() * 5000; // Random Start
        candleOpen = traderPrice;
        if(charts['trader']) charts['trader'].destroy();
        const ctx = document.getElementById('traderChart').getContext('2d');
        charts['trader'] = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: Array(MAX_CANDLES).fill(''),
                datasets: [
                    { label:'Wick', data:Array(MAX_CANDLES).fill(null), backgroundColor:'#64748b', barThickness:2, grouped:false, order:1 },
                    { label:'Body', data:Array(MAX_CANDLES).fill(null), backgroundColor:(c)=>c.raw&&c.raw[1]>=c.raw[0]?'#10b981':'#f43f5e', barThickness:8, grouped:false, order:2 }
                ]
            },
            options: { 
                animation: false, responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, 
                scales: { 
                    x: { display: false }, 
                    y: { position: 'right', grid: { color: '#333' }, min: (ctx) => {
                        // Auto-Zoom Logic
                        const data = ctx.chart.data.datasets[0].data.filter(v => v !== null).flat();
                        return data.length ? Math.min(...data) * 0.99 : undefined;
                    }} 
                } 
            }
        });
        startCandle();
        traderInt = setInterval(tickTrader, 100);
    }

    function startCandle() {
        candleOpen = traderPrice; candleHigh = traderPrice; candleLow = traderPrice; candleClose = traderPrice;
        candleTime = Date.now() + 5000;
        let c = charts['trader'];
        if(c.data.datasets[0].data[MAX_CANDLES-1] !== null) {
            c.data.datasets[0].data.shift(); c.data.datasets[0].data.push(null);
            c.data.datasets[1].data.shift(); c.data.datasets[1].data.push(null);
        }
    }

    function tickTrader() {
        let timeLeft = Math.ceil((candleTime - Date.now())/1000);
        document.getElementById('trader_timer').innerText = timeLeft + "s";
        let noise = (Math.random() - 0.5) * (traderPrice * 0.005);
        traderPrice += noise;
        
        if(traderPrice > candleHigh) candleHigh = traderPrice;
        if(traderPrice < candleLow) candleLow = traderPrice;
        candleClose = traderPrice;

        document.getElementById('trader_price').innerText = traderPrice.toFixed(2);
        
        let c = charts['trader'];
        let idx = MAX_CANDLES - 1;
        for(let i=0; i<MAX_CANDLES; i++) if(c.data.datasets[0].data[i]===null) { idx=i; break; }
        
        c.data.datasets[0].data[idx] = [candleLow, candleHigh];
        c.data.datasets[1].data[idx] = [candleOpen, candleClose];
        c.update('none');

        document.getElementById('trader_eq').innerText = formatCurrency(traderEquity + (traderHold * traderPrice));

        if(Date.now() >= candleTime) startCandle();
    }

    function traderAction(dir) {
        let qty = parseInt(document.getElementById('trader_qty').value);
        if(dir===1 && traderEquity >= traderPrice*qty) { traderHold+=qty; traderEquity -= traderPrice*qty; }
        if(dir===-1 && traderHold >= qty) { traderHold-=qty; traderEquity += traderPrice*qty; }
        document.getElementById('trader_cash').innerText = formatCurrency(traderEquity);
        document.getElementById('trader_hold').innerText = traderHold;
    }
    function resetTrader() { traderEquity=1000000; traderHold=0; initTrader(); }

    // --- GAME 3: FINANCIAL RACE (Wealth Run Remake) ---
    let runActive=false, runLane=1, runScore=0, runAnim; const lanes=[20,50,80];
    function startRun(){ if(runActive)return; runActive=true; runScore=0; document.getElementById('run_score').innerText=0; document.getElementById('run_overlay').style.display='none'; document.querySelectorAll('.game-obj').forEach(e=>e.remove()); spawnObj(); loopRun(); }
    function moveRun(dir) { runLane+=dir; if(runLane<0)runLane=0; if(runLane>2)runLane=2; document.getElementById('run_player').style.left=lanes[runLane]+'%'; }
    function spawnObj() {
        if(!runActive)return;
        const el=document.createElement('div'); el.classList.add('game-obj');
        let type = Math.random();
        if(type > 0.6) { el.classList.add('obj-good'); el.innerText = type>0.8 ? "BONUS" : "PROFIT"; } 
        else { el.classList.add('obj-bad'); el.innerText = type>0.3 ? "DEBT" : "TAX"; }
        
        let l = Math.floor(Math.random()*3);
        el.style.left = lanes[l] + '%'; el.dataset.lane=l; el.dataset.y=0;
        document.getElementById('run_game').appendChild(el);
        setTimeout(spawnObj, 800);
    }
    function loopRun() {
        if(!runActive) return;
        document.querySelectorAll('.game-obj').forEach(el => {
            let y=parseFloat(el.dataset.y)+3; el.dataset.y=y; el.style.top=y+'%';
            if(y>80 && y<90 && parseInt(el.dataset.lane)===runLane) {
                if(el.classList.contains('obj-bad')) { runActive=false; document.getElementById('run_overlay').style.display='flex'; }
                else { runScore+=100; document.getElementById('run_score').innerText=runScore; el.remove(); }
            }
            if(y>100) el.remove();
        });
        runAnim = requestAnimationFrame(loopRun);
    }

    // --- KID 1: COIN QUEST (FIXED LOOP) ---
    let kqI=0, kqS=0; 
    const kqList=[{n:"Apple",t:"need",i:"üçé"}, {n:"PS5",t:"want",i:"üéÆ"}, {n:"Water",t:"need",i:"üíß"}, {n:"Toy",t:"want",i:"üß∏"}, {n:"Medicine",t:"need",i:"üíä"}, {n:"Candy",t:"want",i:"üç¨"}, {n:"Book",t:"need",i:"üìö"}, {n:"Gold",t:"want",i:"üíç"}, {n:"Rice",t:"need",i:"üçö"}, {n:"Car",t:"want",i:"üèéÔ∏è"}];
    function loadKQ() {
        if(kqI>=kqList.length) { document.getElementById('kq_name').innerText="Complete!"; document.getElementById('kq_icon').innerText="üèÜ"; return; }
        let i = kqList[kqI];
        document.getElementById('kq_icon').innerText = i.i;
        document.getElementById('kq_name').innerText = i.n;
        document.getElementById('kq_idx').innerText = (kqI+1);
    }
    function checkKQ(t) {
        if(t===kqList[kqI].t) { kqS++; document.getElementById('kq_res').innerText="‚úÖ Correct!"; } else { document.getElementById('kq_res').innerText="‚ùå Wrong!"; }
        document.getElementById('kq_score').innerText=kqS;
        kqI++; setTimeout(loadKQ, 500);
    }
    function resetKQ() { kqS=0; kqI=0; document.getElementById('kq_score').innerText=0; loadKQ(); }

    // --- KID 2: PIGGY (FIXED) ---
    let pigInt, pigSpawnInt, pigPos=50, pigSc=0, pigActive=false, pigMove=0;
    function startPiggy() { if(pigActive)return; pigActive=true; pigSc=0; pigPos=50; document.getElementById('pig_overlay').style.display='none'; document.querySelectorAll('.drop-item').forEach(e=>e.remove()); updatePig(); pigInt=requestAnimationFrame(loopPig); pigSpawnInt=setInterval(spawnPig, 600); }
    function movePig(d) { pigMove=d*2; } function stopPig() { pigMove=0; }
    function updatePig() { document.getElementById('piggy_player').style.left=pigPos+'%'; }
    function spawnPig() { if(!pigActive)return; const el=document.createElement('div'); el.className='drop-item'; el.innerText=Math.random()>0.3?'üí∞':'üî®'; el.dataset.type=el.innerText==='üí∞'?'good':'bad'; el.style.left=(Math.random()*90+5)+'%'; el.style.top='-50px'; el.dataset.y=-50; document.getElementById('piggy_container').appendChild(el); }
    function loopPig() { if(!pigActive)return; if(pigMove!==0){pigPos+=pigMove;if(pigPos<10)pigPos=10;if(pigPos>90)pigPos=90;updatePig();} document.querySelectorAll('.drop-item').forEach(e=>{ let y=parseFloat(e.dataset.y)+4; e.dataset.y=y; e.style.top=y+'px'; if(y>350&&y<400&&Math.abs(parseFloat(e.style.left)-pigPos)<15){ if(e.dataset.type==='good'){pigSc+=100;document.getElementById('pig_score').innerText=pigSc;e.remove();} else{pigActive=false;clearInterval(pigSpawnInt);document.getElementById('pig_overlay').style.display='flex';} } if(y>460)e.remove(); }); pigInt=requestAnimationFrame(loopPig); }

    setTimeout(() => { calcAll(); }, 100);
</script>
</body>
</html>
