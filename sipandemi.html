<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinCalc Pro 4.0 - Arbitrage Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #6366f1;
            --primary-soft: #e0e7ff;
            --success: #10b981;
            --danger: #ef4444;
            --bg: #f3f4f6;
            --card-bg: #ffffff;
            --text-main: #111827;
            --text-sub: #6b7280;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg); color: var(--text-main); padding: 2rem; min-height: 100vh; }
        .container { max-width: 1200px; margin: 0 auto; }

        /* Header */
        header { text-align: center; margin-bottom: 2rem; }
        h1 { font-weight: 800; color: var(--text-main); letter-spacing: -1px; }
        
        /* Navigation */
        .nav-tabs { display: flex; justify-content: center; gap: 1rem; margin-bottom: 2rem; flex-wrap: wrap; }
        .nav-btn {
            background: white; border: 1px solid #e5e7eb; padding: 0.75rem 1.5rem; border-radius: 50px;
            cursor: pointer; font-weight: 600; color: var(--text-sub); transition: all 0.2s;
        }
        .nav-btn.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }

        /* Dashboard Layout */
        .dashboard { display: grid; grid-template-columns: 1fr 1.2fr; gap: 2rem; display: none; animation: fadeIn 0.4s ease-out; }
        .dashboard.active { display: grid; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Cards */
        .card { background: var(--card-bg); border-radius: 16px; padding: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }

        /* Inputs */
        .input-group { margin-bottom: 1.5rem; }
        .label-row { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        label { font-weight: 600; font-size: 0.9rem; }
        
        .number-display {
            border: 1px solid #e5e7eb; background: #f9fafb; padding: 0.4rem 0.8rem; border-radius: 8px;
            color: var(--primary); font-weight: 700; width: 100px; text-align: right;
        }
        .number-display:focus { outline: 2px solid var(--primary); border-color: transparent; }

        input[type=range] {
            width: 100%; height: 6px; background: #e5e7eb; border-radius: 5px; outline: none; -webkit-appearance: none; cursor: pointer;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 20px; height: 20px; border-radius: 50%; background: var(--primary);
            box-shadow: 0 0 0 4px var(--primary-soft); transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }

        .step-up-group { background: #f0fdf4; padding: 1rem; border-radius: 12px; border: 1px solid #bbf7d0; }
        .step-up-group label { color: #15803d; }
        .step-up-group input[type=range]::-webkit-slider-thumb { background: #15803d; box-shadow: 0 0 0 4px #dcfce7; }
        .step-up-group .number-display { color: #15803d; }

        /* Arbitrage Specific */
        .arb-group { background: #eff6ff; padding: 1rem; border-radius: 12px; border: 1px solid #dbeafe; margin-bottom:1rem; }
        .arb-group label { color: #1d4ed8; }
        
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem; }
        .mini-stat { background: #f9fafb; padding: 1rem; border-radius: 12px; text-align: center; }
        .mini-stat h4 { font-size: 0.75rem; color: var(--text-sub); text-transform: uppercase; margin-bottom: 0.5rem; }
        .mini-stat p { font-size: 1.1rem; font-weight: 700; }
        
        .big-stat { text-align: right; margin-bottom: 1.5rem; border-bottom: 1px solid #f3f4f6; padding-bottom: 1rem; }
        .big-stat strong { font-size: 2rem; color: var(--primary); display: block; }

        .chart-wrapper { position: relative; height: 300px; width: 100%; }

        @media (max-width: 900px) { .dashboard { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>ðŸ’° FinCalc Pro <span style="font-size:0.5em; vertical-align: super; color: var(--primary);">ARBITRAGE</span></h1>
    </header>

    <nav class="nav-tabs">
        <button class="nav-btn active" onclick="setMode('sip')">SIP (Wealth)</button>
        <button class="nav-btn" onclick="setMode('emi')">EMI (Loan)</button>
        <button class="nav-btn" onclick="setMode('swp')">SWP (Income)</button>
        <button class="nav-btn" onclick="setMode('arb')">Arbitrage (Loan vs SWP)</button>
    </nav>

    <div id="sip" class="dashboard active">
        <div class="card">
            <h3>Investment Plan</h3><br>
            <div class="input-group">
                <div class="label-row"><label>Monthly Investment</label><input type="number" class="number-display" id="sip_amt_num"></div>
                <input type="range" id="sip_amt" min="500" max="100000" step="500" value="10000">
            </div>
            <div class="input-group">
                <div class="label-row"><label>Duration (Years)</label><input type="number" class="number-display" id="sip_years_num"></div>
                <input type="range" id="sip_years" min="1" max="40" step="1" value="15">
            </div>
            <div class="input-group">
                <div class="label-row"><label>Expected Return (%)</label><input type="number" class="number-display" id="sip_rate_num"></div>
                <input type="range" id="sip_rate" min="5" max="25" step="0.5" value="12">
            </div>
            <div class="input-group step-up-group">
                <div class="label-row"><label>Annual Step-up (%)</label><input type="number" class="number-display" id="sip_step_num"></div>
                <input type="range" id="sip_step" min="0" max="20" step="1" value="10">
            </div>
        </div>

        <div class="card">
            <div class="big-stat"><span>Maturity Value</span><strong id="sip_total_val">â‚¹ 0</strong></div>
            <div class="stats-grid">
                <div class="mini-stat"><h4>Total Invested</h4><p id="sip_invested_val">â‚¹0</p></div>
                <div class="mini-stat"><h4>Wealth Gained</h4><p id="sip_gains_val" style="color:var(--success)">â‚¹0</p></div>
            </div>
            <div class="chart-wrapper"><canvas id="sipChart"></canvas></div>
        </div>
    </div>

    <div id="emi" class="dashboard">
        <div class="card">
            <h3>Loan Repayment</h3><br>
            <div class="input-group">
                <div class="label-row"><label>Loan Amount</label><input type="number" class="number-display" id="emi_amt_num"></div>
                <input type="range" id="emi_amt" min="100000" max="10000000" step="50000" value="5000000">
            </div>
            <div class="input-group">
                <div class="label-row"><label>Tenure (Years)</label><input type="number" class="number-display" id="emi_years_num"></div>
                <input type="range" id="emi_years" min="1" max="30" step="1" value="20">
            </div>
            <div class="input-group">
                <div class="label-row"><label>Interest Rate (%)</label><input type="number" class="number-display" id="emi_rate_num"></div>
                <input type="range" id="emi_rate" min="6" max="18" step="0.1" value="8.5">
            </div>
            <div class="input-group step-up-group">
                <div class="label-row"><label>Annual EMI Increase (%)</label><input type="number" class="number-display" id="emi_step_num"></div>
                <input type="range" id="emi_step" min="0" max="20" step="1" value="0">
            </div>
        </div>
        <div class="card">
            <div class="big-stat"><span>Starting Monthly EMI</span><strong id="emi_monthly_val">â‚¹ 0</strong><span id="emi_last_val" style="font-size:0.9rem;color:var(--danger)"></span></div>
            <div class="stats-grid">
                <div class="mini-stat"><h4>Total Interest</h4><p id="emi_interest_val" style="color:var(--danger)">â‚¹0</p></div>
                <div class="mini-stat"><h4>Total Repayment</h4><p id="emi_total_val">â‚¹0</p></div>
            </div>
            <div class="chart-wrapper"><canvas id="emiChart"></canvas></div>
        </div>
    </div>

    <div id="swp" class="dashboard">
        <div class="card">
            <h3>Retirement Income</h3><br>
            <div class="input-group">
                <div class="label-row"><label>Total Corpus</label><input type="number" class="number-display" id="swp_corpus_num"></div>
                <input type="range" id="swp_corpus" min="500000" max="20000000" step="100000" value="5000000">
            </div>
            <div class="input-group">
                <div class="label-row"><label>Monthly Withdrawal</label><input type="number" class="number-display" id="swp_withdraw_num"></div>
                <input type="range" id="swp_withdraw" min="5000" max="200000" step="1000" value="30000">
            </div>
            <div class="input-group">
                <div class="label-row"><label>Duration (Years)</label><input type="number" class="number-display" id="swp_years_num"></div>
                <input type="range" id="swp_years" min="1" max="30" step="1" value="20">
            </div>
            <div class="input-group">
                <div class="label-row"><label>Expected Return (%)</label><input type="number" class="number-display" id="swp_rate_num"></div>
                <input type="range" id="swp_rate" min="1" max="15" step="0.1" value="8">
            </div>
            <div class="input-group step-up-group">
                <div class="label-row"><label>Inflation Increase (%)</label><input type="number" class="number-display" id="swp_step_num"></div>
                <input type="range" id="swp_step" min="0" max="15" step="1" value="6">
            </div>
        </div>
        <div class="card">
            <div class="big-stat"><span>Final Balance</span><strong id="swp_final_val">â‚¹ 0</strong></div>
            <div class="stats-grid">
                <div class="mini-stat"><h4>Total Withdrawn</h4><p id="swp_out_val" style="color:var(--success)">â‚¹0</p></div>
                <div class="mini-stat"><h4>Est. Returns</h4><p id="swp_return_val">@ 8% p.a.</p></div>
            </div>
            <div class="chart-wrapper"><canvas id="swpChart"></canvas></div>
        </div>
    </div>

    <div id="arb" class="dashboard">
        <div class="card">
            <h3>Arbitrage Strategy (Loan vs Invest)</h3>
            <p style="font-size:0.8rem; color:var(--text-sub); margin-bottom:15px">Take a loan, invest it, and pay EMI via SWP.</p>
            
            <div class="arb-group">
                <div class="input-group">
                    <div class="label-row"><label>Loan Amount (Invested)</label><input type="number" class="number-display" id="arb_amt_num"></div>
                    <input type="range" id="arb_amt" min="500000" max="10000000" step="50000" value="5000000">
                </div>
                <div class="input-group">
                    <div class="label-row"><label>Loan Interest Rate (%)</label><input type="number" class="number-display" id="arb_loan_rate_num"></div>
                    <input type="range" id="arb_loan_rate" min="6" max="15" step="0.1" value="8.5">
                </div>
                <div class="input-group">
                    <div class="label-row"><label>Loan Tenure (Years)</label><input type="number" class="number-display" id="arb_years_num"></div>
                    <input type="range" id="arb_years" min="1" max="30" step="1" value="15">
                </div>
            </div>

            <div class="input-group">
                <div class="label-row"><label>Investment Return (%)</label><input type="number" class="number-display" id="arb_inv_rate_num"></div>
                <input type="range" id="arb_inv_rate" min="5" max="20" step="0.1" value="10.5">
            </div>
        </div>

        <div class="card">
            <div class="big-stat">
                <span>Net Profit / Loss</span>
                <strong id="arb_net_val">â‚¹ 0</strong>
                <span id="arb_status" style="font-size:0.9rem; display:block; margin-top:5px;"></span>
            </div>
            <div class="stats-grid">
                <div class="mini-stat"><h4>Monthly EMI (Paid via SWP)</h4><p id="arb_emi_val">â‚¹0</p></div>
                <div class="mini-stat"><h4>Remaining Corpus</h4><p id="arb_final_val">â‚¹0</p></div>
            </div>
            <div class="chart-wrapper"><canvas id="arbChart"></canvas></div>
        </div>
    </div>

</div>

<script>
    const formatCurrency = (num) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(num);
    let charts = {};

    function setupSync(id) {
        const slider = document.getElementById(id);
        const num = document.getElementById(id + '_num');
        slider.addEventListener('input', () => { num.value = slider.value; calculateAll(); });
        num.addEventListener('input', () => { slider.value = num.value; calculateAll(); });
        num.value = slider.value;
    }

    function updateChart(id, type, labels, datasets, isCurrency = true) {
        const ctx = document.getElementById(id).getContext('2d');
        if (charts[id]) charts[id].destroy();
        charts[id] = new Chart(ctx, {
            type: type, data: { labels, datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { position: 'bottom' } },
                interaction: { mode: 'index', intersect: false },
                scales: type === 'doughnut' ? {} : {
                    x: { grid: { display: false } },
                    y: { grid: { borderDash: [5, 5] }, ticks: { callback: v => isCurrency ? v/1000 + 'k' : v } }
                }
            }
        });
    }

    // --- CORE ALGORITHMS ---
    function calculateSIP() {
        let P = parseFloat(document.getElementById('sip_amt').value);
        const years = parseFloat(document.getElementById('sip_years').value);
        const rate = parseFloat(document.getElementById('sip_rate').value) / 100;
        const step = parseFloat(document.getElementById('sip_step').value) / 100;
        let totalInvested = 0, currentValue = 0, monthlyRate = rate/12;
        const dataInvested = [], dataValue = [], labels = [];

        for (let y = 1; y <= years; y++) {
            for (let m = 1; m <= 12; m++) {
                currentValue = (currentValue + P) * (1 + monthlyRate);
                totalInvested += P;
            }
            dataInvested.push(totalInvested); dataValue.push(currentValue); labels.push(`Yr ${y}`);
            P *= (1 + step);
        }
        document.getElementById('sip_total_val').innerText = formatCurrency(currentValue);
        document.getElementById('sip_invested_val').innerText = formatCurrency(totalInvested);
        document.getElementById('sip_gains_val').innerText = formatCurrency(currentValue - totalInvested);
        updateChart('sipChart', 'line', labels, [
            { label: 'Invested', data: dataInvested, borderColor: '#9ca3af', borderWidth: 2, pointRadius:0 },
            { label: 'Value', data: dataValue, borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.1)', fill: true }
        ]);
    }

    function calculateEMI() {
        const Loan = parseFloat(document.getElementById('emi_amt').value);
        const years = parseFloat(document.getElementById('emi_years').value);
        const rate = parseFloat(document.getElementById('emi_rate').value) / 100 / 12;
        const step = parseFloat(document.getElementById('emi_step').value) / 100;
        const months = years * 12;
        
        let pvFactor = 0, currentFactor = 1;
        for(let m = 1; m <= months; m++) {
            pvFactor += currentFactor / Math.pow(1 + rate, m);
            if(m % 12 === 0) currentFactor *= (1 + step);
        }
        
        const startEMI = Loan / pvFactor;
        let currentEMI = startEMI, totalPaid = 0, balance = Loan;
        const labels = [], balanceData = [];

        for(let y = 1; y <= years; y++) {
            for(let m=1; m<=12; m++) {
                const interest = balance * rate;
                let principal = currentEMI - interest;
                if(balance - principal < 0) { principal = balance; currentEMI = principal + interest; }
                balance -= principal; totalPaid += currentEMI;
            }
            labels.push(`Yr ${y}`); balanceData.push(balance);
            if (balance > 0) currentEMI *= (1 + step);
        }
        document.getElementById('emi_monthly_val').innerText = formatCurrency(startEMI);
        document.getElementById('emi_last_val').innerText = step > 0 ? `Ends at ${formatCurrency(currentEMI)}` : '';
        document.getElementById('emi_total_val').innerText = formatCurrency(totalPaid);
        document.getElementById('emi_interest_val').innerText = formatCurrency(totalPaid - Loan);
        updateChart('emiChart', 'bar', labels, [{ label: 'Loan Balance', data: balanceData, backgroundColor: '#ef4444' }]);
    }

    function calculateSWP() {
        let corpus = parseFloat(document.getElementById('swp_corpus').value);
        let withdraw = parseFloat(document.getElementById('swp_withdraw').value);
        const years = parseFloat(document.getElementById('swp_years').value);
        const rate = parseFloat(document.getElementById('swp_rate').value) / 100 / 12;
        const step = parseFloat(document.getElementById('swp_step').value) / 100;
        let totalOut = 0;
        const balanceData = [], labels = [];

        for(let y = 1; y <= years; y++) {
            for(let m=1; m<=12; m++) {
                corpus = (corpus * (1+rate)) - withdraw;
                totalOut += withdraw;
                if(corpus < 0) corpus = 0;
            }
            labels.push(`Yr ${y}`); balanceData.push(corpus);
            withdraw *= (1 + step);
        }
        document.getElementById('swp_final_val').innerText = formatCurrency(corpus);
        document.getElementById('swp_out_val').innerText = formatCurrency(totalOut);
        document.getElementById('swp_return_val').innerText = `@ ${document.getElementById('swp_rate').value}% p.a.`;
        updateChart('swpChart', 'line', labels, [{ label: 'Corpus', data: balanceData, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true }]);
    }

    // --- NEW: ARBITRAGE LOGIC ---
    function calculateArb() {
        const Principal = parseFloat(document.getElementById('arb_amt').value);
        const years = parseFloat(document.getElementById('arb_years').value);
        const loanRate = parseFloat(document.getElementById('arb_loan_rate').value) / 100 / 12;
        const invRate = parseFloat(document.getElementById('arb_inv_rate').value) / 100 / 12;
        
        // 1. Calculate Standard EMI
        const n = years * 12;
        const emi = (Principal * loanRate * Math.pow(1 + loanRate, n)) / (Math.pow(1 + loanRate, n) - 1);

        // 2. Simulate Investment Corpus paying that EMI
        let corpus = Principal;
        const corpusData = [];
        const loanData = []; // For visual comparison
        const labels = [];
        let loanBalance = Principal;

        for(let y = 1; y <= years; y++) {
            for(let m=1; m<=12; m++) {
                // Investment grows, then pays EMI
                corpus = (corpus * (1 + invRate)) - emi;
                
                // Track Loan Balance for visual
                const interest = loanBalance * loanRate;
                loanBalance -= (emi - interest);
            }
            labels.push(`Yr ${y}`);
            corpusData.push(corpus);
            loanData.push(Math.max(0, loanBalance));
        }

        const isProfit = corpus > 0;
        const statusText = isProfit 
            ? `Profitable Strategy (Delta: ${(parseFloat(document.getElementById('arb_inv_rate').value) - parseFloat(document.getElementById('arb_loan_rate').value)).toFixed(1)}%)` 
            : `Loss Making (Negative Arbitrage)`;
        
        document.getElementById('arb_net_val').innerText = formatCurrency(corpus);
        document.getElementById('arb_net_val').style.color = isProfit ? 'var(--success)' : 'var(--danger)';
        document.getElementById('arb_status').innerText = statusText;
        document.getElementById('arb_status').style.color = isProfit ? 'var(--success)' : 'var(--danger)';
        
        document.getElementById('arb_emi_val').innerText = formatCurrency(emi);
        document.getElementById('arb_final_val').innerText = formatCurrency(Math.max(0, corpus));

        updateChart('arbChart', 'line', labels, [
            { label: 'Investment Value', data: corpusData, borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.1)', fill: true },
            { label: 'Loan Balance (Ref)', data: loanData, borderColor: '#ef4444', borderDash: [5, 5], fill: false }
        ]);
    }

    function calculateAll() {
        const active = document.querySelector('.dashboard.active').id;
        if(active === 'sip') calculateSIP();
        if(active === 'emi') calculateEMI();
        if(active === 'swp') calculateSWP();
        if(active === 'arb') calculateArb();
    }

    function setMode(mode) {
        document.querySelectorAll('.dashboard').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(mode).classList.add('active');
        event.target.classList.add('active');
        setTimeout(calculateAll, 100); 
    }

    ['sip_amt', 'sip_years', 'sip_rate', 'sip_step', 
     'emi_amt', 'emi_years', 'emi_rate', 'emi_step',
     'swp_corpus', 'swp_withdraw', 'swp_years', 'swp_step', 'swp_rate',
     'arb_amt', 'arb_loan_rate', 'arb_years', 'arb_inv_rate'].forEach(setupSync);

    calculateSIP(); 
</script>

</body>
</html>
