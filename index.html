<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CalcIndiaPlayLearn</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Space+Grotesk:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #020617;
            --card-glass: rgba(15, 23, 42, 0.96);
            --border-glass: rgba(148, 163, 184, 0.35);
            --primary: #6366f1;
            --accent: #f43f5e;
            --success: #22c55e;
            --gold: #f59e0b;
            --neon-blue: #00f3ff;
            --neon-pink: #d946ef;
            --text-main: #f9fafb;
            --text-sub: #9ca3af;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg-dark);
            color: var(--text-main); 
            font-family: 'Outfit', sans-serif;
            min-height: 100vh;
            padding-bottom: 3rem;
            overflow-x: hidden;
            transition: background 0.3s ease;
        }

        body.mode-default { background: radial-gradient(circle at top, #1e293b 0%, #020617 55%, #000 100%); }
        body.mode-trader { background: radial-gradient(circle at center, #1e1b4b 0%, #020617 100%); }
        body.mode-run { background: linear-gradient(to bottom, #2e1065 0%, #0f172a 50%, #020617 100%); }
        body.mode-kids { background: linear-gradient(120deg, #0ea5e9 0%, #8b5cf6 50%, #f97316 100%); }

        .container { max-width: 1200px; margin: 0 auto; padding: 1rem; }

        header { display: flex; justify-content: space-between; align-items: center; padding: 1.5rem 0 1rem; margin-bottom: 1rem; border-bottom: 1px solid var(--border-glass); }
        .brand { font-family: 'Space Grotesk', sans-serif; font-size: 1.6rem; font-weight: 700; background: linear-gradient(to right, #6366f1, #22c55e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; display: flex; align-items: center; gap: 10px; }
        .brand-tagline { font-size: 0.85rem; color: var(--text-sub); }

        .nav-dock { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 1.25rem; position: relative; z-index: 100; }
        .dropdown-container { position: relative; }
        .drop-trigger {
            width: 100%; padding: 12px; background: rgba(15,23,42,0.9); border: 1px solid rgba(148,163,184,0.4);
            border-radius: 999px; color: var(--text-sub); font-weight: 700; font-size: 0.9rem;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: all 0.2s;
        }
        .drop-trigger i { font-size: 1.1rem; }
        .drop-trigger.active-cat {
            background: linear-gradient(to right, #4f46e5, #22c55e);
            color: white;
            border-color: transparent;
            box-shadow: 0 0 20px rgba(99,102,241,0.5);
            transform: translateY(-1px);
        }
        .drop-menu {
            position: absolute; top: 115%; left: 0; width: 100%; min-width: 220px;
            background: rgba(15, 23, 42, 0.98); border: 1px solid var(--border-glass); border-radius: 18px; padding: 8px;
            display: none; flex-direction: column; gap: 5px; box-shadow: 0 18px 40px -18px rgba(0,0,0,0.85); z-index: 200;
        }
        .dropdown-container:last-child .drop-menu { right: 0; left: auto; }
        .show-menu { display: flex; animation: dropIn 0.18s ease-out; }
        @keyframes dropIn { from { opacity: 0; transform: translateY(-6px); } to { opacity: 1; transform: translateY(0); } }
        
        .menu-btn {
            background: transparent; border: none; padding: 10px 12px; color: var(--text-sub); text-align: left;
            font-size: 0.9rem; font-weight: 600; cursor: pointer; border-radius: 10px; display: flex; align-items: center; gap: 10px; transition: 0.15s;
            position: relative;
        }
        .menu-btn:hover { background: rgba(148,163,184,0.08); color: #e5e7eb; padding-left: 14px; }
        .menu-btn.active {
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary);
            border: 1px solid rgba(99, 102, 241, 0.5);
        }
        .menu-btn.active::after {
            content: "";
            position: absolute;
            left: 12px;
            right: 12px;
            bottom: 5px;
            height: 2px;
            border-radius: 999px;
            background: linear-gradient(to right, #6366f1, #22c55e);
        }

        .app-view { display: none; opacity: 0; transition: opacity 0.2s ease-in; }
        .app-view.active-view { display: grid; opacity: 1; }
        
        .tool-layout { grid-template-columns: 1fr 1.5fr; gap: 1.5rem; }
        .game-layout { grid-template-columns: 1fr 350px; gap: 1.5rem; }
        .kid-layout { grid-template-columns: 1fr; gap: 1.5rem; max-width: 800px; margin: 0 auto; }

        .glass-card { background: var(--card-glass); backdrop-filter: blur(24px); border: 1px solid var(--border-glass); border-radius: 22px; padding: 1.8rem; box-shadow: 0 18px 40px -22px rgba(15,23,42,0.9); }
        .subtitle { color: var(--text-sub); font-size: 0.85rem; margin-top: 4px; }

        .input-wrap { margin-bottom: 1.3rem; }
        .input-header { display: flex; justify-content: space-between; margin-bottom: 0.4rem; color: var(--text-sub); font-size: 0.85rem; }
        .input-val { font-weight: 700; color: var(--primary); }
        input[type=range] { width: 100%; height: 6px; background: rgba(148,163,184,0.3); border-radius: 999px; -webkit-appearance: none; cursor: pointer; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #e5e7eb; border: 2px solid #4f46e5; margin-top: -6px; box-shadow: 0 0 0 4px rgba(99,102,241,0.3); }

        .summary-text { color: var(--text-sub); font-size: 0.9rem; margin-top: 0.6rem; min-height: 1.2em; }

        .tag-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            font-size: 0.78rem;
            border-radius: 999px;
            font-weight: 600;
            margin-top: 8px;
        }

        .big-value { font-size: 2.6rem; font-weight: 800; background: linear-gradient(to right, #f9fafb, #cbd5e1); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .chart-container { position: relative; height: 280px; width: 100%; margin-top: 1rem; }

        .game-screen { background: #020617; height: 380px; border-radius: 18px; position: relative; border: 1px solid #334155; overflow: hidden; display:flex; flex-direction:column; justify-content:center; align-items:center; }
        .game-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(15,23,42,0.96); z-index: 20; display:none; flex-direction: column; justify-content: center; align-items: center; text-align: center; color: white; transition: opacity 0.2s ease; }

        .reset-btn { background: rgba(239, 68, 68, 0.16); border: 1px solid rgba(239, 68, 68, 0.6); color: #fecaca; padding: 6px 12px; border-radius: 999px; font-size: 0.78rem; cursor: pointer; transition: 0.12s; }
        .reset-btn:hover { background: rgba(239, 68, 68, 0.25); transform: translateY(-1px); }

        .kid-btn { padding: 12px; border-radius: 12px; border: none; font-size: 0.98rem; font-weight: 800; cursor: pointer; width: 48%; margin: 4px; transition: transform 0.08s ease, box-shadow 0.08s ease; box-shadow: 0 6px 16px -10px rgba(0,0,0,0.8); }
        .kid-btn:active { transform: scale(0.96) translateY(1px); box-shadow: 0 3px 10px -8px rgba(0,0,0,0.9); }
        .btn-need { background: var(--success); color: white; }
        .btn-want { background: var(--accent); color: white; }

        .control-pad { display: flex; gap: 24px; margin-top: 15px; width: 100%; justify-content: center; flex-wrap: wrap; }
        .control-btn { width: 70px; height: 70px; border-radius: 50%; background: rgba(15,23,42,0.9); color: white; font-size: 1.6rem; cursor: pointer; border: 1px solid rgba(148,163,184,0.6); display:flex; align-items:center; justify-content:center; transition: 0.08s; box-shadow: 0 10px 24px -16px rgba(0,0,0,0.9); }
        .control-btn:active { transform: scale(0.94) translateY(1px); box-shadow: 0 4px 12px -10px rgba(0,0,0,0.9); }

        #run_game_container { width: 100%; height: 100%; position: relative; background: linear-gradient(to bottom, #1e1b4b 0%, #4c1d95 50%, #db2777 100%); perspective: 600px; overflow: hidden; }
        .road { position: absolute; bottom: 0; left: 50%; transform: translateX(-50%) rotateX(60deg); width: 340px; height: 120%; background: #020617; border-left: 8px solid var(--neon-blue); border-right: 8px solid var(--neon-blue); box-shadow: 0 0 40px rgba(0, 243, 255, 0.4); }
        .lane-marker { position: absolute; top: 0; left: 33%; width: 4px; height: 100%; background: rgba(148,163,184,0.65); }
        .lane-marker.right { left: 66%; }
        .player-ball { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); font-size: 3.5rem; line-height: 1; z-index: 10; transition: left 0.05s ease-out, transform 0.15s ease-out; }
        .obstacle, .coin { position: absolute; transform: translateX(-50%); display: flex; justify-content: center; align-items: center; z-index: 5; }
        .obstacle { background: #020617; border: 4px solid #ef4444; border-radius: 50%; width: 100%; height: 35px; box-shadow: inset 0 0 20px #000; }
        .coin { font-size: 0px; background: radial-gradient(circle, #fbbf24, #d97706); border: 4px solid #fff; border-radius: 50%; box-shadow: 0 0 25px #fbbf24; }

        #piggy_container { width: 100%; height: 420px; position: relative; background: radial-gradient(circle at top, #0f172a 0%, #020617 60%); overflow: hidden; border: 2px solid var(--neon-pink); border-radius: 18px; }
        .piggy { position: absolute; bottom: 20px; width: 80px; height: 80px; background: #ec4899; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 3rem; border: 3px solid white; z-index: 10; transition: left 0.1s; }
        .drop-item { position: absolute; font-size: 2.4rem; transition: top 0.05s linear; }

        .float-label {
            position: absolute;
            pointer-events: none;
            font-size: 0.8rem;
            color: #bbf7d0;
            text-shadow: 0 0 10px rgba(34,197,94,0.9);
            opacity: 0;
            transform: translateY(0);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        @media (max-width: 900px) { 
            .app-view.active-view { grid-template-columns: 1fr; }
            .game-layout { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body class="mode-default">

<div class="container">
    <header>
        <div>
            <div class="brand"><i class="ph-fill ph-currency-inr"></i> CalcIndiaPlayLearn</div>
            <div class="brand-tagline">Plan, play, and learn money skills together.</div>
        </div>
    </header>

    <nav class="nav-dock">
        <div class="dropdown-container">
            <button class="drop-trigger active-cat" onclick="toggleMenu('menu-tools', this)"><i class="ph-fill ph-wrench"></i> Tools <i class="ph-bold ph-caret-down"></i></button>
            <div id="menu-tools" class="drop-menu">
                <button class="menu-btn active" onclick="switchTab('sip', this, 'tools')"><i class="ph-bold ph-trend-up"></i> SIP Calculator</button>
                <button class="menu-btn" onclick="switchTab('emi', this, 'tools')"><i class="ph-bold ph-house"></i> EMI Calculator</button>
                <button class="menu-btn" onclick="switchTab('arb', this, 'tools')"><i class="ph-bold ph-scales"></i> Arbitrage</button>
            </div>
        </div>
        <div class="dropdown-container">
            <button class="drop-trigger" onclick="toggleMenu('menu-arcade', this)"><i class="ph-fill ph-game-controller"></i> Arcade <i class="ph-bold ph-caret-down"></i></button>
            <div id="menu-arcade" class="drop-menu">
                <button class="menu-btn" onclick="switchTab('game1', this, 'arcade')"><i class="ph-fill ph-chart-candlestick"></i> Trader Pro</button>
                <button class="menu-btn" onclick="switchTab('game2', this, 'arcade')"><i class="ph-fill ph-shield-check"></i> Defense</button>
                <button class="menu-btn" onclick="switchTab('game3', this, 'arcade')"><i class="ph-fill ph-person-simple-run"></i> Wealth Run</button>
            </div>
        </div>
        <div class="dropdown-container">
            <button class="drop-trigger" onclick="toggleMenu('menu-kids', this)"><i class="ph-fill ph-baby"></i> Kids <i class="ph-bold ph-caret-down"></i></button>
            <div id="menu-kids" class="drop-menu">
                <button class="menu-btn" onclick="switchTab('kid1', this, 'kids')"><i class="ph-fill ph-coins"></i> Coin Quest</button>
                <button class="menu-btn" onclick="switchTab('kid2', this, 'kids')"><i class="ph-fill ph-piggy-bank"></i> Piggy Dash</button>
            </div>
        </div>
    </nav>

    <!-- TOOLS -->
    <div id="sip" class="app-view tool-layout active-view" style="display:grid;opacity:1;">
        <div class="glass-card">
            <h3><i class="ph ph-sliders"></i> SIP Calculator</h3>
            <p class="subtitle">Slide to change monthly amount, years, and expected return.</p><br>
            <div class="input-wrap">
                <div class="input-header"><label>Monthly Investment</label><span class="input-val" id="sip_amt_val">‚Çπ 25 K</span></div>
                <input type="range" id="sip_amt" min="1000" max="200000" step="500" value="25000">
            </div>
            <div class="input-wrap">
                <div class="input-header"><label>Duration</label><span class="input-val" id="sip_years_val">10 Yrs</span></div>
                <input type="range" id="sip_years" min="1" max="40" step="1" value="10">
            </div>
            <div class="input-wrap">
                <div class="input-header"><label>Expected Return (p.a.)</label><span class="input-val" id="sip_rate_val">12 %</span></div>
                <input type="range" id="sip_rate" min="5" max="30" step="0.5" value="12">
            </div>
            <p id="sip_summary" class="summary-text"></p>
        </div>
        <div class="glass-card">
            <div class="big-number-block">
                <div class="input-header">Future Value</div>
                <div class="big-value" id="sip_final">‚Çπ 0</div>
                <div id="sip_tag" class="tag-chip" style="background:rgba(59,130,246,0.12);color:#93c5fd;border:1px solid rgba(59,130,246,0.5);margin-top:6px;"></div>
            </div>
            <div class="chart-container"><canvas id="sipLineChart"></canvas></div>
        </div>
    </div>

    <div id="emi" class="app-view tool-layout">
        <div class="glass-card">
            <h3><i class="ph ph-house"></i> EMI Calculator</h3>
            <p class="subtitle">Understand your monthly EMI and interest over time.</p><br>
            <div class="input-wrap">
                <div class="input-header"><label>Loan Amount</label><span class="input-val" id="emi_amt_val">‚Çπ 50 L</span></div>
                <input type="range" id="emi_amt" min="500000" max="10000000" step="100000" value="5000000">
            </div>
            <div class="input-wrap">
                <div class="input-header"><label>Tenure</label><span class="input-val" id="emi_years_val">20 Yrs</span></div>
                <input type="range" id="emi_years" min="1" max="30" step="1" value="20">
            </div>
            <div class="input-wrap">
                <div class="input-header"><label>Interest Rate (p.a.)</label><span class="input-val" id="emi_rate_val">8.5 %</span></div>
                <input type="range" id="emi_rate" min="6" max="15" step="0.1" value="8.5">
            </div>
            <p id="emi_summary" class="summary-text"></p>
        </div>
        <div class="glass-card">
            <div class="big-number-block">
                <div class="input-header">Monthly EMI</div>
                <div class="big-value" id="emi_monthly">‚Çπ 0</div>
                <div id="emi_tag" class="tag-chip"></div>
            </div>
            <div class="chart-container"><canvas id="emiChart"></canvas></div>
        </div>
    </div>

    <div id="arb" class="app-view tool-layout">
        <div class="glass-card">
            <h3><i class="ph ph-scales"></i> Loan vs Invest</h3>
            <p class="subtitle">Compare borrowing cost vs potential investment growth over 10 years.</p><br>
            <div class="input-wrap">
                <div class="input-header"><label>Loan Amount</label><span class="input-val" id="arb_amt_val">‚Çπ 50 L</span></div>
                <input type="range" id="arb_amt" min="500000" max="10000000" step="100000" value="5000000">
            </div>
            <div class="input-wrap">
                <div class="input-header"><label>Loan Rate (p.a.)</label><span class="input-val" id="arb_loan_rate_val">8 %</span></div>
                <input type="range" id="arb_loan_rate" min="1" max="15" step="0.1" value="8">
            </div>
            <div class="input-wrap">
                <div class="input-header"><label>Investment Return (p.a.)</label><span class="input-val" id="arb_inv_rate_val">12 %</span></div>
                <input type="range" id="arb_inv_rate" min="1" max="20" step="0.1" value="12">
            </div>
            <p id="arb_summary" class="summary-text"></p>
        </div>
        <div class="glass-card">
            <div class="big-number-block">
                <div class="input-header">Net Profit / Loss after 10 yrs</div>
                <div class="big-value" id="arb_net">‚Çπ 0</div>
                <div id="arb_status" class="tag-chip"></div>
            </div>
            <div class="chart-container"><canvas id="arbChart"></canvas></div>
        </div>
    </div>

    <!-- ARCADE -->
    <div id="game1" class="app-view game-layout">
        <div class="glass-card">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <h3>Trader Pro</h3>
                    <p class="subtitle">Buy low, sell high. Watch your equity change.</p>
                </div>
                <button class="reset-btn" onclick="resetMM()">Restart</button>
            </div>
            <div class="game-screen">
                <div style="position:absolute;top:10px;left:10px;color:var(--success);font-size:1.1rem;">NIFTY: <span id="mm_price">20000</span></div>
                <div style="position:absolute;bottom:10px;left:10px;color:var(--gold);font-size:0.85rem;" id="mm_pattern">Tap BUY/SELL to play.</div>
                <canvas id="mmChart"></canvas>
            </div>
            <div style="margin-top:15px;display:flex;gap:10px;">
                <button class="kid-btn btn-need" onclick="mmTrade('buy')">BUY</button>
                <button class="kid-btn btn-want" onclick="mmTrade('sell')">SELL</button>
            </div>
        </div>
        <div class="glass-card">
            <h4>Portfolio</h4>
            <div class="big-value" id="mm_equity">‚Çπ 10.0 L</div>
            <div style="color:var(--text-sub);margin-top:6px;">Cash: <span id="mm_cash">‚Çπ 10.0 L</span></div>
        </div>
    </div>

    <div id="game2" class="app-view game-layout">
        <div class="glass-card">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <h3>Defense</h3>
                    <p class="subtitle">Each year markets boom or crash. Decide wisely.</p>
                </div>
                <button class="reset-btn" onclick="resetPD()">Restart</button>
            </div>
            <div class="defense-card" style="margin-top:10px;">
                <h2 id="pd_year" style="color:var(--primary)">Year 1</h2>
                <h3 id="pd_event" style="margin-top:4px;">Market Stable</h3>
                <div id="pd_buttons" style="display:flex;gap:10px;justify-content:center;margin-top:20px;">
                    <button class="kid-btn btn-need" onclick="pdResolve('invest')">Invest</button>
                    <button class="kid-btn btn-want" onclick="pdResolve('hold')">Hold</button>
                </div>
            </div>
        </div>
        <div class="glass-card">
            <h4>Net Worth</h4>
            <div class="big-value" id="pd_networth">‚Çπ 10.0 L</div>
            <div id="pd_fb" style="margin-top:10px;font-weight:bold;color:var(--gold)"></div>
        </div>
    </div>

    <div id="game3" class="app-view kid-layout">
        <div class="glass-card" style="border-color:var(--neon-blue);">
            <div style="display:flex;justify-content:space-between;">
                <div>
                    <h3>Wealth Run</h3>
                    <p class="subtitle">Dodge bad debts, grab good coins.</p>
                </div>
                <div style="font-weight:bold;color:var(--gold);margin-left:10px;">Score: <span id="run_score">0</span></div>
            </div>
            <div class="game-screen" style="height:340px;margin-top:15px;border:2px solid #334155;">
                <div id="run_game_container">
                    <div class="road"><div class="lane-marker"></div><div class="lane-marker right"></div></div>
                    <div id="run_player" class="player-ball">üèéÔ∏è</div>
                    <div id="run_overlay" class="game-overlay"><h2>CRASHED!</h2><p style="margin:6px 0 14px;font-size:0.9rem;">Avoid red circles or jump over them.</p><button class="kid-btn btn-need" onclick="startRunGame()">Try Again</button></div>
                    <div id="run_start" class="game-overlay" style="display:flex;flex-direction:column;">
                        <h2>Ready?</h2>
                        <p style="margin:6px 0 14px;font-size:0.9rem;">Tap left / right to move and UP to jump.</p>
                        <button class="kid-btn btn-need" onclick="startRunGame()">Start</button>
                    </div>
                </div>
            </div>
            <div class="control-pad">
                <button class="control-btn" onclick="moveRun('left')"><i class="ph-bold ph-arrow-left"></i></button>
                <button class="control-btn" onclick="moveRun('jump')">UP</button>
                <button class="control-btn" onclick="moveRun('right')"><i class="ph-bold ph-arrow-right"></i></button>
            </div>
        </div>
    </div>

    <!-- KIDS -->
    <div id="kid1" class="app-view kid-layout">
        <div class="glass-card" style="border-color:#0ea5e9;background:rgba(14,165,233,0.08);">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <h2>Coin Quest</h2>
                    <p class="subtitle">Is it a need or a want?</p>
                </div>
                <button class="reset-btn" onclick="resetKQ()">Reset</button>
            </div>
            <div style="text-align:center;margin-top:8px;">
                <div style="font-size:1rem;margin:6px 0;">Score: <span id="kq_score">0</span></div>
                <div style="font-size:5rem;margin:16px 0;" id="kq_icon">üçé</div>
                <h3 id="kq_item" style="margin-bottom:16px;">Apple</h3>
                <div style="display:flex;gap:20px;justify-content:center;">
                    <button class="kid-btn btn-need" onclick="checkKQ('need')">NEED</button>
                    <button class="kid-btn btn-want" onclick="checkKQ('want')">WANT</button>
                </div>
                <div id="kq_msg" style="margin-top:14px;height:22px;font-size:0.9rem;"></div>
            </div>
        </div>
    </div>

    <div id="kid2" class="app-view kid-layout">
        <div class="glass-card" style="border-color:var(--neon-pink);background:rgba(236,72,153,0.08);">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <h2>Piggy Dash</h2>
                    <p class="subtitle">Move the piggy bank to catch cash and avoid bad choices.</p>
                </div>
                <div style="color:var(--gold);font-weight:700;">‚Çπ <span id="piggy_score">0</span></div>
            </div>
            <div class="game-screen" id="piggy_container" style="margin-top:15px;">
                <div id="piggy_player" class="piggy">üê∑</div>
                <div id="piggy_overlay" class="game-overlay" style="display:flex;">
                    <h2>Catch Cash!</h2>
                    <p style="margin:6px 0 14px;font-size:0.9rem;">Hold left / right buttons to move.</p>
                    <button class="kid-btn btn-need" onclick="startPiggy()">Start</button>
                </div>
            </div>
            <div class="control-pad">
                <button class="control-btn" onmousedown="movePiggy('left')" onmouseup="stopPiggy()" ontouchstart="movePiggy('left')" ontouchend="stopPiggy()"><i class="ph-bold ph-arrow-left"></i></button>
                <button class="control-btn" onmousedown="movePiggy('right')" onmouseup="stopPiggy()" ontouchstart="movePiggy('right')" ontouchend="stopPiggy()"><i class="ph-bold ph-arrow-right"></i></button>
            </div>
        </div>
    </div>

</div>

<script>
    const formatCurrency = (num) => new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(num);
    let charts = {};

    // game state vars (consistent)
    let runActive = false;
    let pigActive = false;
    let pigInt = null, pigSpawnInt = null;
    let mmInt = null;

    function toggleMenu(menuId, btn) {
        document.querySelectorAll('.drop-menu').forEach(m => { if(m.id !== menuId) m.classList.remove('show-menu'); });
        document.getElementById(menuId).classList.toggle('show-menu');
    }

    function switchTab(targetId, btn, category) {
        // close dropdowns
        document.querySelectorAll('.drop-menu').forEach(m => m.classList.remove('show-menu'));
        // active top trigger
        document.querySelectorAll('.drop-trigger').forEach(b => b.classList.remove('active-cat'));
        btn.closest('.dropdown-container').querySelector('.drop-trigger').classList.add('active-cat');
        // active menu item
        document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        // hide all views
        document.querySelectorAll('.app-view').forEach(v => {
            v.classList.remove('active-view');
            v.style.display = 'none';
        });

        // stop games safely
        if (runActive) gameOverRun();
        if (pigActive) { pigActive = false; if (pigSpawnInt) clearInterval(pigSpawnInt); if (pigInt) cancelAnimationFrame(pigInt); }
        if (mmInt) { clearInterval(mmInt); mmInt = null; }

        // background
        document.body.className = 'mode-default';
        if (category === 'arcade') {
            if (targetId === 'game1') document.body.classList.add('mode-trader');
            if (targetId === 'game3') document.body.classList.add('mode-run');
        } else if (category === 'kids') {
            document.body.classList.add('mode-kids');
        }

        const targetView = document.getElementById(targetId);
        targetView.style.display = 'grid';

        setTimeout(() => {
            targetView.classList.add('active-view');
            if (category === 'tools') {
                calcAll();
            } else if (targetId === 'game1') {
                initMM();
            } else if (targetId === 'kid1') {
                loadKQ();
            }
        }, 10);
    }

    function setupInput(id) {
        const el = document.getElementById(id);
        el.addEventListener('input', (e) => {
            let valId = id + '_val';
            let type = id.includes('rate') ? '%' : (id.includes('years') ? 'Yrs' : '');
            let val = parseFloat(e.target.value);
            document.getElementById(valId).innerText = (type === '%' || type === 'Yrs') ? val + " " + type : formatCurrency(val);
            calcAll();
        });
        let ev = new Event('input'); el.dispatchEvent(ev);
    }

    function calcAll() {
        // SIP
        if (document.getElementById('sip').style.display !== 'none') {
            const P = parseFloat(document.getElementById('sip_amt').value),
                  N = parseFloat(document.getElementById('sip_years').value),
                  R = parseFloat(document.getElementById('sip_rate').value);
            let v = 0, mR = R / 1200;
            for (let i = 0; i < N * 12; i++) v = (v + P) * (1 + mR);
            document.getElementById('sip_final').innerText = formatCurrency(v);
            const invested = P * 12 * N;
            document.getElementById('sip_summary').innerText =
                `Investing ${formatCurrency(P)} per month for ${N} years at ${R}% p.a. means you put in ${formatCurrency(invested)} and it could grow to around ${formatCurrency(v)}.`;

            const sipTag = document.getElementById('sip_tag');
            if (N >= 15 && R >= 12) sipTag.innerText = "Long-term, growth-focused SIP";
            else if (N <= 5) sipTag.innerText = "Short-term SIP horizon";
            else sipTag.innerText = "Balanced SIP plan";

            drawChart('sipLineChart', 'line',
                Array.from({length:N},(_,i)=>i+1),
                Array.from({length:N},(_,i)=>{let t=0;for(let m=0;m<(i+1)*12;m++)t=(t+P)*(1+mR);return t}),
                '#6366f1'
            );
        }
        // EMI
        if (document.getElementById('emi').style.display !== 'none') {
            const L = parseFloat(document.getElementById('emi_amt').value),
                  Y = parseFloat(document.getElementById('emi_years').value) * 12,
                  I = parseFloat(document.getElementById('emi_rate').value) / 1200;
            const emi = (L * I * Math.pow(1 + I, Y)) / (Math.pow(1 + I, Y) - 1);
            document.getElementById('emi_monthly').innerText = formatCurrency(emi);
            const totalPaid = emi * Y;
            const totalInterest = totalPaid - L;
            document.getElementById('emi_summary').innerText =
              `You pay about ${formatCurrency(emi)} every month for ${Y/12} years, with total interest of ${formatCurrency(totalInterest)} on a principal of ${formatCurrency(L)}.`;

            const ratio = totalInterest / L;
            const tag = document.getElementById('emi_tag');
            tag.className = 'tag-chip';
            if (ratio > 1) {
                tag.innerText = "High interest cost";
                tag.style.background = "rgba(248,113,113,0.1)";
                tag.style.color = "#fecaca";
                tag.style.border = "1px solid rgba(248,113,113,0.7)";
            } else {
                tag.innerText = "Moderate interest cost";
                tag.style.background = "rgba(34,197,94,0.12)";
                tag.style.color = "#bbf7d0";
                tag.style.border = "1px solid rgba(34,197,94,0.7)";
            }
            drawChart('emiChart', 'bar', ['Principal','Interest'], [L, totalInterest], '#6366f1');
        }
        // Arbitrage
        if (document.getElementById('arb').style.display !== 'none') {
            const A = parseFloat(document.getElementById('arb_amt').value),
                  lR = parseFloat(document.getElementById('arb_loan_rate').value)/100,
                  iR = parseFloat(document.getElementById('arb_inv_rate').value)/100;
            let c = A, l = A, lbs = [], d1 = [], d2 = [];
            for (let i = 1; i <= 10; i++) { c *= (1+iR); l *= (1+lR); lbs.push(i); d1.push(c); d2.push(l); }
            const net = c - l;
            document.getElementById('arb_net').innerText = formatCurrency(net);
            document.getElementById('arb_summary').innerText =
                `Over 10 years, your loan grows to about ${formatCurrency(l)} at ${lR*100}% p.a., while your investment could reach ${formatCurrency(c)} at ${iR*100}% p.a. Net result is ${formatCurrency(net)}.`;

            const status = document.getElementById('arb_status');
            status.className = 'tag-chip';
            if (net > 0) {
                status.innerText = "Profitable spread";
                status.style.background = "rgba(34,197,94,0.12)";
                status.style.color = "#bbf7d0";
                status.style.border = "1px solid rgba(34,197,94,0.7)";
            } else if (Math.abs(net) < A * 0.05) {
                status.innerText = "Barely worth the risk";
                status.style.background = "rgba(251,191,36,0.12)";
                status.style.color = "#facc15";
                status.style.border = "1px solid rgba(250,204,21,0.7)";
            } else {
                status.innerText = "Unattractive arbitrage";
                status.style.background = "rgba(248,113,113,0.1)";
                status.style.color = "#fecaca";
                status.style.border = "1px solid rgba(248,113,113,0.7)";
            }
            drawChart('arbChart', 'line', lbs, d1, '#10b981', d2);
        }
    }

    function drawChart(id, type, labels, data, color, data2=null) {
        const canvas = document.getElementById(id);
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        if (charts[id]) charts[id].destroy();
        let datasets = [{
            label: 'Value',
             data,
            borderColor: color,
            backgroundColor: color === '#6366f1' ? 'rgba(99,102,241,0.24)' : color,
            fill: type === 'line',
            tension: 0.25
        }];
        if (data2) datasets.push({
            label: 'Loan',
             data2,
            borderColor: '#f43f5e',
            borderDash: [5,5],
            fill: false,
            tension: 0.25
        });
        charts[id] = new Chart(ctx, {
            type: type,
             { labels, datasets },
            options: {
                responsive:true,
                maintainAspectRatio:false,
                interaction: { mode: 'index', intersect: false },
                plugins:{
                    legend:{display:true, labels:{color:'#e5e7eb', font:{size:11}}},
                    tooltip:{
                        enabled:true,
                        callbacks:{
                            label: ctx => {
                                const v = ctx.parsed.y;
                                return (typeof v === 'number') ? formatCurrency(v) : v;
                            }
                        }
                    }
                },
                scales:{
                    x:{grid:{display:false}, ticks:{color:'#9ca3af', font:{size:10}}},
                    y:{grid:{color:'rgba(148,163,184,0.2)'}, ticks:{color:'#9ca3af', font:{size:10}}}
                }
            }
        });
    }

    // GAME 1: Trader Pro
    let mmP=20000, mmC=1000000, mmS=0;
    function initMM() {
        const ctx = document.getElementById('mmChart').getContext('2d');
        if (!charts['mm']) {
            charts['mm'] = new Chart(ctx, {
                type:'bar',
                {
                    labels:Array(30).fill(''),
                    datasets:[
                        {Array(30).fill(null),backgroundColor:'#4b5563',barThickness:2},
                        {Array(30).fill(null),backgroundColor:(c)=>c.raw&&c.raw[1]>=c.raw[0]?'#22c55e':'#f97316',barThickness:7}
                    ]
                },
                options:{
                    animation:false,
                    responsive:true,
                    maintainAspectRatio:false,
                    plugins:{legend:{display:false}},
                    scales:{x:{display:false},y:{position:'right',grid:{color:'#1f2933'}, ticks:{color:'#9ca3af', font:{size:9}}}}
                }
            });
        }
        if (!mmInt) {
            mmInt = setInterval(()=>{
                if(!document.getElementById('game1').classList.contains('active-view')) return;
                mmP += (Math.random()-0.5)*50; 
                document.getElementById('mm_price').innerText=mmP.toFixed(0);
                updateMM();
                let c=charts['mm'];
                c.data.datasets[0].data.shift(); c.data.datasets[0].data.push([mmP-20, mmP+20]);
                c.data.datasets[1].data.shift(); c.data.datasets[1].data.push([mmP, mmP+(Math.random()-0.5)*30]);
                c.update('none');
            }, 120);
        }
    }
    function updateMM(){document.getElementById('mm_equity').innerText=formatCurrency(mmC+mmS*mmP);document.getElementById('mm_cash').innerText=formatCurrency(mmC);}
    function mmTrade(t){
        if(t==='buy'&&mmC>mmP){mmS++;mmC-=mmP;}
        if(t==='sell'&&mmS>0){mmS--;mmC+=mmP;}
        document.getElementById('mm_pattern').innerText = t === 'buy' ? "You bought 1 unit." : "You sold 1 unit.";
        updateMM();
    }
    function resetMM(){mmC=1000000;mmS=0;mmP=20000;updateMM();document.getElementById('mm_pattern').innerText="Tap BUY/SELL to play."; }

    // GAME 2: Defense
    let pdN=1000000, pdY=1; const pdScen=[{t:"Boom year!",val:1.2},{t:"Crash year!",val:0.8}];
    function pdResolve(c){
        if(pdY>10)return;
        let s=pdScen[Math.floor(Math.random()*2)];
        pdN *= (c==='invest' ? s.val : (s.val>1 ? 1.05 : 0.98));
        pdY++;
        document.getElementById('pd_networth').innerText=formatCurrency(pdN);
        document.getElementById('pd_fb').innerText=s.t + (c==='invest' ? " (you were in the market)" : " (you stayed defensive)");
        if(pdY>10)document.getElementById('pd_event').innerText="Game over! 10 years done.";
        document.getElementById('pd_year').innerText="Year "+Math.min(pdY,10);
    }
    function resetPD(){
        pdN=1000000;pdY=1;
        document.getElementById('pd_networth').innerText=formatCurrency(pdN);
        document.getElementById('pd_fb').innerText='';
        document.getElementById('pd_event').innerText='Market Stable';
        document.getElementById('pd_year').innerText='Year 1';
    }

    // GAME 3: Wealth Run
    let runGameInterval, spawnInterval, runLane=1, runIsJumping=false, runScore=0;
    const lanes=[15,50,85];
    function startRunGame(){
        if(runActive)return;
        runActive=true; runScore=0;
        document.getElementById('run_score').innerText=0;
        document.getElementById('run_start').style.display='none';
        document.getElementById('run_overlay').style.display='none';
        document.querySelectorAll('.obstacle,.coin').forEach(e=>e.remove());
        runGameInterval=requestAnimationFrame(gameLoopRun);
        spawnInterval=setInterval(spawnObject,700);
    }
    function moveRun(d){
        if(!runActive)return;
        if(d==='left'&&runLane>0)runLane--;
        if(d==='right'&&runLane<2)runLane++;
        document.getElementById('run_player').style.left=lanes[runLane]+'%';
        if(d==='jump'&&!runIsJumping){
            runIsJumping=true;
            document.getElementById('run_player').style.transform='translateX(-50%) scale(1.5)';
            setTimeout(()=>{
                document.getElementById('run_player').style.transform='translateX(-50%) scale(1)';
                runIsJumping=false;
            },500);
        }
    }
    function spawnObject(){
        if(!runActive)return;
        const type=Math.random()>0.4?'obstacle':'coin';
        const l=Math.floor(Math.random()*3);
        const el=document.createElement('div');
        el.className=type; el.style.top='25%'; el.style.left=lanes[l]+'%'; el.dataset.lane=l; el.dataset.y=25;
        document.getElementById('run_game_container').appendChild(el);
        function move(){
            if(!runActive||!el.parentNode)return;
            let y=parseFloat(el.dataset.y)+2; el.dataset.y=y;
            let s=0.2+((y-25)/75)*2; el.style.top=y+'%'; el.style.transform=`translateX(-50%) scale(${s})`;
            if(y>85&&y<95&&parseInt(el.dataset.lane)===runLane){
                if(type==='obstacle'&&!runIsJumping) gameOverRun();
                else if(type==='coin'){runScore+=100;document.getElementById('run_score').innerText=runScore;el.remove();}
            }
            if(y>110)el.remove(); else requestAnimationFrame(move);
        } requestAnimationFrame(move);
    }
    function gameLoopRun(){if(runActive)requestAnimationFrame(gameLoopRun);}
    function gameOverRun(){
        runActive=false;
        clearInterval(spawnInterval);
        cancelAnimationFrame(runGameInterval);
        document.getElementById('run_overlay').style.display='flex';
    }

    // KIDS: Coin Quest
    let kqS=0, kqI=0; const kq=[
        {n:"Apple",t:"need",i:"üçé",msgC:"Healthy food is a need.",msgW:"Food is usually a need."},
        {n:"Toy Car",t:"want",i:"üöó",msgC:"Toys are wants.",msgW:"Fun, but not a need."},
        {n:"School Bag",t:"need",i:"üéí",msgC:"School supplies are needs.",msgW:"You need it to study."},
        {n:"Ice Cream",t:"want",i:"üç¶",msgC:"Treats are wants.",msgW:"Nice to have, not needed."}
    ];
    function loadKQ(){let i=kq[kqI%kq.length];document.getElementById('kq_icon').innerText=i.i;document.getElementById('kq_item').innerText=i.n;}
    function checkKQ(c){
        let i=kq[kqI%kq.length];
        if(c===i.t){
            kqS++;
            document.getElementById('kq_msg').innerText=i.msgC;
        } else {
            document.getElementById('kq_msg').innerText=i.msgW;
        }
        kqI++; document.getElementById('kq_score').innerText=kqS;
        setTimeout(loadKQ,600);
    }
    function resetKQ(){kqS=0;kqI=0;document.getElementById('kq_score').innerText=0;document.getElementById('kq_msg').innerText='';loadKQ();}

    // KIDS: Piggy Dash
    let pigPos=50, pigSc=0, pigDir=0;
    function startPiggy(){
        if(pigActive)return;
        pigActive=true;pigSc=0;pigPos=50;
        document.getElementById('piggy_score').innerText=pigSc;
        document.getElementById('piggy_overlay').style.display='none';
        document.querySelectorAll('.drop-item').forEach(e=>e.remove());
        pigInt=requestAnimationFrame(loopPig);
        pigSpawnInt=setInterval(spawnPig,600);
        document.getElementById('piggy_player').style.left=pigPos+'%';
    }
    function movePiggy(d){pigDir=d==='left'?-2:2;}
    function stopPiggy(){pigDir=0;}
    function spawnPig(){
        if(!pigActive)return;
        const el=document.createElement('div');
        el.className='drop-item';
        el.innerText=Math.random()>0.3?'üí∞':'üî®';
        el.dataset.type=el.innerText==='üí∞'?'good':'bad';
        el.style.left=(Math.random()*90+5)+'%';
        el.style.top='-50px';
        el.dataset.y=-50;
        document.getElementById('piggy_container').appendChild(el);
    }
    function showFloatLabel(text, color){
        const pig = document.getElementById('piggy_player');
        const rect = pig.getBoundingClientRect();
        const containerRect = document.getElementById('piggy_container').getBoundingClientRect();
        const label = document.createElement('div');
        label.className = 'float-label';
        label.innerText = text;
        label.style.left = (rect.left - containerRect.left + 10) + 'px';
        label.style.top = (rect.top - containerRect.top - 10) + 'px';
        label.style.color = color;
        document.getElementById('piggy_container').appendChild(label);
        requestAnimationFrame(()=>{
            label.style.opacity = 1;
            label.style.transform = 'translateY(-12px)';
        });
        setTimeout(()=>{
            label.style.opacity = 0;
            label.style.transform = 'translateY(-24px)';
            setTimeout(()=>label.remove(),200);
        }, 450);
    }
    function loopPig(){
        if(!pigActive)return;
        if(pigDir!==0){
            pigPos+=pigDir;
            if(pigPos<10)pigPos=10;
            if(pigPos>90)pigPos=90;
            document.getElementById('piggy_player').style.left=pigPos+'%';
        }
        document.querySelectorAll('.drop-item').forEach(e=>{
            let y=parseFloat(e.dataset.y)+4; e.dataset.y=y; e.style.top=y+'px';
            if(y>320&&y<380&&Math.abs(parseFloat(e.style.left)-pigPos)<15){
                if(e.dataset.type==='good'){
                    pigSc+=100;document.getElementById('piggy_score').innerText=pigSc;e.remove();
                    showFloatLabel("+‚Çπ100","#bbf7d0");
                } else {
                    pigActive=false;
                    clearInterval(pigSpawnInt);
                    document.getElementById('piggy_overlay').style.display='flex';
                    showFloatLabel("Oops!","#fecaca");
                }
            }
            if(y>460)e.remove();
        });
        requestAnimationFrame(loopPig);
    }

    // INIT
    setupInput('sip_amt'); setupInput('sip_years'); setupInput('sip_rate');
    setupInput('emi_amt'); setupInput('emi_years'); setupInput('emi_rate');
    setupInput('arb_amt'); setupInput('arb_loan_rate'); setupInput('arb_inv_rate');
    calcAll();
    loadKQ();
</script>
</body>
</html>
